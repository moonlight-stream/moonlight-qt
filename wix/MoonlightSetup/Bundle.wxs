<!-- This block is autogenerated using scripts\update-msvcredist.ps1 -->
<?define VCREDIST_VER = "14.36.32532.0" ?>
<?define VCREDIST_X86_SIZE = "13837672" ?>
<?define VCREDIST_X86_SHA512 = "EC70786704EAD0494FAB8F7A9F46554FEACA45C79B831C5963ECC20243FA0F31053B6E0CEB450F86C16E67E739C4BE53AD202C2397C8541365B7252904169B41" ?>
<?define VCREDIST_X86_URL = "https://download.visualstudio.microsoft.com/download/pr/eaab1f82-787d-4fd7-8c73-f782341a0c63/5365A927487945ECB040E143EA770ADBB296074ECE4021B1D14213BDE538C490/VC_redist.x86.exe" ?>
<?define VCREDIST_X86_UPGRADE_CODE = "65E5BD06-6392-3027-8C26-853107D3CF1A" ?>
<?define VCREDIST_X64_SIZE = "25355496" ?>
<?define VCREDIST_X64_SHA512 = "70A888D5891EFD2A48D33C22F35E9178BD113032162DC5A170E7C56F2D592E3C59A08904B9F1B54450C80F8863BDA746E431B396E4C1624B91FF15DD701BD939" ?>
<?define VCREDIST_X64_URL = "https://download.visualstudio.microsoft.com/download/pr/eaab1f82-787d-4fd7-8c73-f782341a0c63/917C37D816488545B70AFFD77D6E486E4DD27E2ECE63F6BBAAF486B178B2B888/VC_redist.x64.exe" ?>
<?define VCREDIST_X64_UPGRADE_CODE = "36F68A90-239C-34DF-B58C-64B30153CE35" ?>
<?define VCREDIST_ARM64_SIZE = "11511496" ?>
<?define VCREDIST_ARM64_SHA512 = "5A70C09060DED33EE9129728C97AD0E9B70BE5010706FB59817359D189E87F5A599DFFF5070A10A48404C511C6395A8B5C69BF6FFFA5DD2B4DE083EF1265CFB8" ?>
<?define VCREDIST_ARM64_URL = "https://download.visualstudio.microsoft.com/download/pr/eaab1f82-787d-4fd7-8c73-f782341a0c63/37342E0ABDAEAE0297F64A889F842AC9453139639FB0178C0754A7D2F330043A/VC_redist.arm64.exe" ?>
<?define VCREDIST_ARM64_UPGRADE_CODE = "DC9BAE42-810B-423A-9E25-E4073F1C7B00" ?>

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:bal="http://wixtoolset.org/schemas/v4/wxs/bal" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Bundle Name="Moonlight Game Streaming Client"
		  Version="!(bind.PackageVersion.Moonlight_x64)"
		  Manufacturer="Moonlight Game Streaming Project"
		  UpgradeCode="466fa35d-4be4-40ef-9ce5-afadc3b63bc5"
		  HelpUrl="https://github.com/moonlight-stream/moonlight-docs/wiki/Setup-Guide"
		  UpdateUrl="https://github.com/moonlight-stream/moonlight-qt/releases"
		  DisableModify="yes"
		  IconSourceFile="..\..\app\moonlight.ico">

    <bal:Condition Message="Moonlight requires Windows 7 or later." Condition="VersionNT &gt;= v6.1" />

    <Variable Name="InstallFolder" Type="formatted" Value="[ProgramFiles6432Folder]Moonlight Game Streaming" />

    <!-- Define "Add desktop shortcut" -checkbox's state by defining a variable
         which has same name as the checkbox has. Value 1 means that checkbox
         is checked, 0 means that is unchecked-->
    <!-- Set checkbox's state as checked by default -->
    <Variable Name="AddDesktopShortcutCheckbox" Type="numeric" Value="1" />
    <!-- Get checkbox's state from registry if present. The registry value
         "DesktopShortcutInstallState" is set in Product.wxs. -->
    <util:RegistrySearch Variable="HasDesktopShortcutInstallStateRegKey" Root="HKCU" Key="Software\Moonlight Game Streaming Project" Value="DesktopShortcutInstallState" Result="exists" />
    <util:RegistrySearch Variable="AddDesktopShortcutCheckbox" Root="HKCU" Key="Software\Moonlight Game Streaming Project" Value="DesktopShortcutInstallState" Condition="HasDesktopShortcutInstallStateRegKey" />

    <util:ProductSearch Id="VCREDIST_14_x86"
						UpgradeCode="$(var.VCREDIST_X86_UPGRADE_CODE)"
						Result="version"
						Variable="VCREDIST_14_x86" />

    <util:ProductSearch Id="VCREDIST_14_x64"
						UpgradeCode="$(var.VCREDIST_X64_UPGRADE_CODE)"
						Result="version"
						Variable="VCREDIST_14_x64" />

    <util:ProductSearch Id="VCREDIST_14_ARM64"
						UpgradeCode="$(var.VCREDIST_ARM64_UPGRADE_CODE)"
						Result="version"
						Variable="VCREDIST_14_ARM64" />

    <BootstrapperApplication>
      <bal:WixStandardBootstrapperApplication ShowVersion="yes"
											  LicenseFile="license.rtf"
											  LogoFile="..\..\app\moonlight_wix.png"
											  LaunchTarget="[InstallFolder]\Moonlight.exe"
											  ThemeFile="RtfTheme.xml"
											  Theme="rtfLicense" />
    </BootstrapperApplication>

    <Chain>
      <ExePackage Cache="remove"
				  PerMachine="yes"
				  Permanent="yes"
				  Vital="yes"
				  InstallCondition="(NOT VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 332)"
				  DetectCondition="VCREDIST_14_x86 &gt;= v$(var.VCREDIST_VER)"
				  InstallArguments="/install /quiet /norestart">
        
        <ExePackagePayload Description="Microsoft Visual C++ 2015-2022 Redistributable - x86"
						   ProductName="Microsoft Visual C++ 2015-2022 Redistributable - x86"
						   Size="$(var.VCREDIST_X86_SIZE)"
						   Version="$(var.VCREDIST_VER)"
						   Hash="$(var.VCREDIST_X86_SHA512)"
						   Name="VC_redist.x86.exe"
						   DownloadUrl="$(var.VCREDIST_X86_URL)" />

        <!-- Newer version installed is fine -->
        <ExitCode Value="1638" Behavior="success" />
      </ExePackage>

      <ExePackage Cache="remove"
				  PerMachine="yes"
				  Permanent="yes"
				  Vital="yes"
                  InstallCondition="(VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 34404)"
				  DetectCondition="VCREDIST_14_x64 &gt;= v$(var.VCREDIST_VER)"
				  InstallArguments="/install /quiet /norestart">
        
        <ExePackagePayload Description="Microsoft Visual C++ 2015-2022 Redistributable - x64"
						   ProductName="Microsoft Visual C++ 2015-2022 Redistributable - x64"
						   Size="$(var.VCREDIST_X64_SIZE)"
						   Version="$(var.VCREDIST_VER)"
						   Hash="$(var.VCREDIST_X64_SHA512)"
						   Name="VC_redist.x64.exe"
						   DownloadUrl="$(var.VCREDIST_X64_URL)" />

        <!-- Newer version installed is fine -->
        <ExitCode Value="1638" Behavior="success" />
      </ExePackage>

      <?if $(var.INCLUDE_ARM64) != 0 ?>
        <ExePackage Cache="remove"
					PerMachine="yes"
					Permanent="yes"
					Vital="yes"
                    InstallCondition="NativeMachine = 43620"
					DetectCondition="VCREDIST_14_ARM64 &gt;= v$(var.VCREDIST_VER)"
					InstallArguments="/install /quiet /norestart">
          
          <ExePackagePayload Description="Microsoft Visual C++ 2015-2022 Redistributable - ARM64"
							 ProductName="Microsoft Visual C++ 2015-2022 Redistributable - ARM64"
							 Size="$(var.VCREDIST_ARM64_SIZE)"
							 Version="$(var.VCREDIST_VER)"
							 Hash="$(var.VCREDIST_ARM64_SHA512)"
							 Name="VC_redist.arm64.exe"
							 DownloadUrl="$(var.VCREDIST_ARM64_URL)" />

          <!-- Newer version installed is fine -->
          <ExitCode Value="1638" Behavior="success" />
        </ExePackage>
      <?endif?>

      <MsiPackage Id="Moonlight_x86"
				  SourceFile="$(env.BUILD_ROOT)\build-x86-$(env.BUILD_CONFIG)\Moonlight.msi"
				  Name="Moonlight_x86.msi"
				  InstallCondition="(NOT VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 332)"
				  Vital="yes">
        <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
        <MsiProperty Name="ADDDESKTOPSHORTCUT" Value="[AddDesktopShortcutCheckbox]" />
      </MsiPackage>

      <MsiPackage Id="Moonlight_x64"
				  SourceFile="$(env.BUILD_ROOT)\build-x64-$(env.BUILD_CONFIG)\Moonlight.msi"
				  Name="Moonlight_x64.msi"
                  InstallCondition="(VersionNT64 AND NOT NativeMachine) OR (NativeMachine = 34404)"
				  Vital="yes">
        <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
        <MsiProperty Name="ADDDESKTOPSHORTCUT" Value="[AddDesktopShortcutCheckbox]" />
      </MsiPackage>

      <?if $(var.INCLUDE_ARM64) != 0 ?>
        <MsiPackage Id="Moonlight_arm64"
					SourceFile="$(env.BUILD_ROOT)\build-arm64-$(env.BUILD_CONFIG)\Moonlight.msi"
					Name="Moonlight_arm64.msi"
                    InstallCondition="NativeMachine = 43620"
					Vital="yes">
          <MsiProperty Name="INSTALLFOLDER" Value="[InstallFolder]" />
          <MsiProperty Name="ADDDESKTOPSHORTCUT" Value="[AddDesktopShortcutCheckbox]" />
        </MsiPackage>
      <?endif?>
    </Chain>

  </Bundle>
</Wix>
